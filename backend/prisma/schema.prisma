// Prisma Schema - Ivan Reseller Database (PostgreSQL Version)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================================
// MODELS
// ====================================

model User {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  email            String    @unique
  password         String
  fullName         String?
  role             String    @default("USER") // "ADMIN" or "USER"
  commissionRate   Float     @default(0.10) // 10%
  fixedMonthlyCost Float     @default(17.00) // $17 USD monthly
  balance          Float     @default(0)
  totalEarnings    Float     @default(0)
  totalSales       Int       @default(0)
  isActive         Boolean   @default(true)
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdBy        Int? // ID del admin que creó este usuario (null si es admin o auto-creado)

  // Relations
  products             Product[]
  sales                Sale[]
  commissions          Commission[]
  apiCredentials       ApiCredential[]
  activities           Activity[]
  workflowConfig       UserWorkflowConfig?
  createdUsers         User[]                @relation("UserCreator") // Usuarios creados por este admin
  creator              User?                 @relation("UserCreator", fields: [createdBy], references: [id])
  adminCommissions     AdminCommission[] // Comisiones que recibe como admin de usuarios creados
  successfulOperations SuccessfulOperation[] // Operaciones exitosas del usuario
  marketplaceListings  MarketplaceListing[]
  opportunities        Opportunity[]
  aiSuggestions        AISuggestion[]
  manualAuthSessions   ManualAuthSession[]
  marketplaceAuthStatuses MarketplaceAuthStatus[]
  sharedCredentials    ApiCredential[] @relation("SharedCredentialOwner")

  @@map("users")
}

model ApiCredential {
  id          Int      @id @default(autoincrement())
  userId      Int
  apiName     String // ebay, mercadolibre, amazon, paypal, groq, email, twilio, slack, stripe, etc.
  environment String   @default("production") // sandbox, production
  credentials String // JSON string with encrypted API keys
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  scope       CredentialScope @default(user)
  sharedById  Int?

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedBy  User? @relation("SharedCredentialOwner", fields: [sharedById], references: [id], onDelete: SetNull)

  @@unique([userId, apiName, environment, scope])
  @@map("api_credentials")
}

enum CredentialScope {
  user
  global
}

model Product {
  id              Int       @id @default(autoincrement())
  userId          Int
  aliexpressUrl   String
  title           String
  description     String?
  aliexpressPrice Float
  suggestedPrice  Float
  finalPrice      Float?
  category        String?
  images          String // JSON string with array of image URLs
  productData     String? // JSON string with full scraped data
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, PUBLISHED, INACTIVE
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  approvalId      String? // Marketplace approval ID
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales                Sale[]
  successfulOperations SuccessfulOperation[]
  marketplaceListings  MarketplaceListing[]

  @@map("products")
}

model Sale {
  id               Int       @id @default(autoincrement())
  userId           Int
  productId        Int
  orderId          String    @unique
  marketplace      String // ebay, mercadolibre, amazon
  salePrice        Float
  aliexpressCost   Float
  marketplaceFee   Float
  grossProfit      Float
  commissionAmount Float
  netProfit        Float
  status           String    @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED, RETURNED
  trackingNumber   String?
  isCompleteCycle  Boolean   @default(false) // Si completó ciclo completo sin devoluciones
  completedAt      DateTime? // Fecha de completado del ciclo
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  product             Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  commission          Commission?
  adminCommissions    AdminCommission[]
  successfulOperation SuccessfulOperation? // Relación one-to-one con SuccessfulOperation

  @@map("sales")
}

model Commission {
  id            Int       @id @default(autoincrement())
  userId        Int
  saleId        Int       @unique
  amount        Float
  status        String    @default("PENDING") // PENDING, SCHEDULED, PAID, FAILED
  scheduledAt   DateTime?
  paidAt        DateTime?
  failureReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("commissions")
}

model Activity {
  id          Int      @id @default(autoincrement())
  userId      Int?
  action      String // login, logout, product_created, sale_completed, etc.
  description String
  ipAddress   String?
  userAgent   String?
  metadata    String? // JSON string with additional data
  createdAt   DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activities")
}

// ✅ CONFIGURACIÓN DE WORKFLOW POR USUARIO
model UserWorkflowConfig {
  id           Int    @id @default(autoincrement())
  userId       Int    @unique
  environment  String @default("sandbox") // sandbox, production
  workflowMode String @default("manual") // manual, automatic, hybrid

  // Configuración por etapa del dropshipping
  stageScrape          String @default("automatic") // manual, automatic, guided
  stageAnalyze         String @default("automatic") // manual, automatic, guided
  stagePublish         String @default("manual") // manual, automatic, guided
  stagePurchase        String @default("manual") // manual, automatic, guided
  stageFulfillment     String @default("manual") // manual, automatic, guided
  stageCustomerService String @default("manual") // manual, automatic, guided

  // Configuraciones de automatización
  autoApproveThreshold Float? // Confianza mínima para auto-aprobar
  autoPublishThreshold Float? // Confianza mínima para auto-publicar
  maxAutoInvestment    Float? // Inversión máxima para auto-operaciones
  workingCapital       Float  @default(500) // Capital de trabajo disponible en PayPal (USD)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_workflow_configs")
}

// ✅ COMISIONES DE ADMIN POR USUARIOS CREADOS
model AdminCommission {
  id             Int       @id @default(autoincrement())
  adminId        Int // ID del admin que recibe la comisión
  userId         Int // ID del usuario que generó la venta
  saleId         Int // ID de la venta que generó la comisión
  amount         Float // Monto de la comisión del admin
  commissionType String    @default("user_sale") // user_sale, monthly_fee, etc.
  status         String    @default("PENDING") // PENDING, PAID, FAILED
  paidAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)
  sale  Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("admin_commissions")
}

// ✅ TRACKING DE OPERACIONES EXITOSAS (CICLOS COMPLETOS)
model SuccessfulOperation {
  id            Int    @id @default(autoincrement())
  userId        Int
  productId     Int
  saleId        Int    @unique // Una venta solo puede tener una operación exitosa registrada
  operationType String @default("full_cycle") // full_cycle, partial, etc.

  // Datos de la operación
  startDate      DateTime
  completionDate DateTime
  daysToComplete Int
  totalProfit    Float
  expectedProfit Float
  profitAccuracy Float // % de diferencia entre esperado y real

  // Estado de la operación
  hadReturns           Boolean @default(false)
  hadIssues            Boolean @default(false)
  issuesDescription    String?
  customerSatisfaction Int? // 1-5 rating

  // Datos de aprendizaje
  aiPredictionScore Float?
  aiConfidence      Float?
  actualSuccess     Boolean @default(true)
  learningPattern   String? // JSON con patrones identificados

  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("successful_operations")
}

// ✅ CONFIGURACIÓN DEL SISTEMA (SystemConfig)
model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_configs")
}

// ✅ LISTINGS DE MARKETPLACE
model MarketplaceListing {
  id          Int       @id @default(autoincrement())
  productId   Int
  userId      Int
  marketplace String // ebay, mercadolibre, amazon
  listingId   String // ID del listing en el marketplace
  listingUrl  String?
  sku         String?
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([marketplace, listingId])
  @@map("marketplace_listings")
}

// ✅ OPORTUNIDADES DE NEGOCIO
model Opportunity {
  id                 Int      @id @default(autoincrement())
  userId             Int
  sourceMarketplace  String? // aliexpress, ebay, etc.
  sourceProductId    Int?
  title              String
  costUsd            Float
  suggestedPriceUsd  Float
  profitMargin       Float
  roiPercentage      Float
  competitionLevel   String? // low, medium, high
  marketDemand       String? // low, medium, high
  confidenceScore    Float
  feesConsidered     String? // JSON
  targetMarketplaces String? // JSON array
  status             String   @default("PENDING") // PENDING, APPROVED, REJECTED, PUBLISHED
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  competitionSnapshots CompetitionSnapshot[]

  @@map("opportunities")
}

// ✅ SNAPSHOTS DE COMPETENCIA
model CompetitionSnapshot {
  id               Int      @id @default(autoincrement())
  opportunityId    Int
  marketplace      String // ebay, mercadolibre, amazon
  region           String?
  currency         String?
  listingsFound    Int?
  averagePrice     Float?
  minPrice         Float?
  maxPrice         Float?
  medianPrice      Float?
  competitivePrice Float?
  topListings      String? // JSON
  createdAt        DateTime @default(now())

  // Relations
  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@map("competition_snapshots")
}

// ✅ SUGERENCIAS IA
model AISuggestion {
  id              Int      @id @default(autoincrement())
  userId          Int
  type            String // pricing, inventory, marketing, listing, optimization, automation
  priority        String // high, medium, low
  title           String
  description     String
  impactRevenue   Float    @default(0)
  impactTime      Float    @default(0) // horas ahorradas
  difficulty      String // easy, medium, hard
  confidence      Float // 0-100
  actionable      Boolean  @default(true)
  implemented     Boolean  @default(false)
  implementedAt   DateTime?
  estimatedTime   String
  requirements    String? // JSON array
  steps           String? // JSON array
  relatedProducts String? // JSON array
  metrics         String? // JSON object { currentValue, targetValue, unit }
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, title])
  @@map("ai_suggestions")
}

model ManualAuthSession {
  id          Int      @id @default(autoincrement())
  token       String   @unique
  provider    String
  userId      Int
  status      String   @default("pending")
  cookies     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime?
  completedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, provider, status])
  @@map("manual_auth_sessions")
}

model MarketplaceAuthStatus {
  id                    Int      @id @default(autoincrement())
  userId                Int      @map("user_id")
  marketplace           String
  status                String   @default("unknown")
  message               String?
  requiresManual        Boolean  @default(false) @map("requires_manual")
  lastAutomaticAttempt  DateTime? @map("last_automatic_attempt")
  lastAutomaticSuccess  DateTime? @map("last_automatic_success")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, marketplace])
  @@index([marketplace, status])
  @@map("marketplace_auth_status")
}
