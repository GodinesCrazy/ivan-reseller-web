# ??? Arquitectura del Sistema - Ivan Reseller

**Versión:** 1.0.0  
**Última actualización:** 2025-01-23

---

## ?? Índice

1. [Diagrama de Arquitectura](#diagrama-de-arquitectura)
2. [Componentes Principales](#componentes-principales)
3. [Comunicación entre Módulos](#comunicación-entre-módulos)
4. [Stack Tecnológico](#stack-tecnológico)
5. [Flujo de Datos](#flujo-de-datos)

---

## ?? Diagrama de Arquitectura

### Arquitectura General

```
???????????????????????????????????????????????????????????????????
?                         VERCEL (Frontend)                        ?
?                    React + TypeScript + Vite                     ?
?                         Port: 5173 (dev)                         ?
???????????????????????????????????????????????????????????????????
                              ?
                              ? HTTPS
                              ?
????????????????????????????????????????????????????????????????????
?                      RAILWAY (Backend)                           ?
?              Node.js 20 + Express + TypeScript                   ?
?                         Port: 3000                               ?
?                                                                   ?
?  ????????????????????????????????????????????????????????????   ?
?  ?                    Express App (app.ts)                  ?   ?
?  ?  ????????????????  ????????????????  ????????????????   ?   ?
?  ?  ?   Routes     ?  ?  Middleware  ?  ?   Services   ?   ?   ?
?  ?  ?  (52 files)  ?  ?  (14 files)  ?  ?  (93 files)  ?   ?   ?
?  ?  ????????????????  ????????????????  ????????????????   ?   ?
?  ????????????????????????????????????????????????????????????   ?
?                                                                   ?
?  ????????????????????????????????????????????????????????????   ?
?  ?              Background Workers (BullMQ)                 ?   ?
?  ?  ????????????????  ????????????????  ????????????????   ?   ?
?  ?  ?   Scraping   ?  ?  Publishing  ?  ?    Payout    ?   ?   ?
?  ?  ?     Queue    ?  ?     Queue    ?  ?     Queue    ?   ?   ?
?  ?  ????????????????  ????????????????  ????????????????   ?   ?
?  ????????????????????????????????????????????????????????????   ?
?                                                                   ?
?  ????????????????????????????????????????????????????????????   ?
?  ?            Scheduled Tasks (node-cron + BullMQ)           ?   ?
?  ?  ? Financial Alerts (6:00 AM)                            ?   ?
?  ?  ? Commission Processing (2:00 AM)                        ?   ?
?  ?  ? AliExpress Auth Health (4:00 AM)                      ?   ?
?  ?  ? FX Rates Refresh (1:00 AM)                            ?   ?
?  ????????????????????????????????????????????????????????????   ?
????????????????????????????????????????????????????????????????????
                              ?
        ?????????????????????????????????????????????
        ?                     ?                       ?
??????????????????  ????????????????????  ????????????????????
?  PostgreSQL    ?  ?     Redis        ?  ?   Socket.IO     ?
?  (Database)    ?  ?  (Cache/Queue)  ?  ?  (Real-time)     ?
?  Port: 5432    ?  ?   Port: 6379     ?  ?  (WebSocket)     ?
??????????????????  ????????????????????  ????????????????????
```

### Arquitectura de Despliegue

```
???????????????????????????????????????????????????????????????
?                    VERCEL (CDN + Hosting)                    ?
?  ? Frontend estático (React build)                          ?
?  ? Rewrites a Railway para /api/*                           ?
?  ? SSL automático                                            ?
???????????????????????????????????????????????????????????????
                              ?
                              ? Proxy
                              ?
????????????????????????????????????????????????????????????????
?                    RAILWAY (Backend API)                      ?
?  ? Node.js runtime                                            ?
?  ? Auto-deploy desde GitHub                                   ?
?  ? Health checks: /health, /ready                            ?
????????????????????????????????????????????????????????????????
                              ?
        ?????????????????????????????????????????????
        ?                     ?                       ?
??????????????????  ????????????????????  ????????????????????
?  Railway       ?  ?   Railway        ?  ?   External       ?
?  PostgreSQL    ?  ?   Redis          ?  ?   APIs           ?
?  (Managed DB)  ?  ?   (Optional)     ?  ?   (eBay, ML, etc)?
??????????????????  ????????????????????  ????????????????????
```

---

## ?? Componentes Principales

### 1. Frontend (React + TypeScript)

**Ubicación:** `frontend/`

**Tecnologías:**
- React 18
- TypeScript 5
- Vite (build tool)
- Zustand (state management)
- React Router (routing)
- Socket.IO Client (real-time)
- Tailwind CSS (styling)

**Estructura:**
```
frontend/
??? src/
?   ??? pages/          # Páginas principales (25+ páginas)
?   ??? components/     # Componentes reutilizables
?   ??? services/       # API clients
?   ??? stores/         # Zustand stores
?   ??? hooks/          # Custom hooks
?   ??? utils/          # Utilidades
```

**Evidencia:** `frontend/package.json`, `frontend/src/App.tsx`

---

### 2. Backend (Node.js + Express)

**Ubicación:** `backend/`

**Tecnologías:**
- Node.js 20+
- Express 4
- TypeScript 5
- Prisma ORM
- BullMQ (colas)
- Socket.IO (WebSocket)

**Estructura:**
```
backend/
??? src/
?   ??? api/routes/     # 52 archivos de rutas
?   ??? services/       # 93 servicios
?   ??? middleware/     # 14 middlewares
?   ??? config/         # Configuración
?   ??? modules/        # Módulos específicos
?   ??? utils/          # Utilidades
??? prisma/
?   ??? schema.prisma   # Schema de BD
?   ??? migrations/     # Migraciones
??? dist/               # Código compilado
```

**Evidencia:** `backend/package.json`, `backend/src/app.ts`

---

### 3. Base de Datos (PostgreSQL)

**Ubicación:** Railway (managed) o local

**ORM:** Prisma

**Modelos principales:**
- User (usuarios)
- Product (productos)
- Sale (ventas)
- Commission (comisiones)
- Opportunity (oportunidades)
- ApiCredential (credenciales)
- MarketplaceListing (listings)
- PurchaseLog (logs de compras)
- Y 17+ modelos más

**Evidencia:** `backend/prisma/schema.prisma`

---

### 4. Redis (Cache y Colas)

**Ubicación:** Railway (managed) o local

**Uso:**
- Cache de sesiones
- Colas BullMQ
- Rate limiting
- Token blacklisting

**Estado:** Opcional pero recomendado

**Evidencia:** `backend/src/config/redis.ts`

---

### 5. Workers y Colas (BullMQ)

**Colas implementadas:**
1. `scrapingQueue` - Trabajos de scraping
2. `publishingQueue` - Trabajos de publicación
3. `payoutQueue` - Trabajos de pago
4. `syncQueue` - Trabajos de sincronización
5. `financial-alerts` - Alertas financieras
6. `commission-processing` - Procesamiento de comisiones
7. `ali-auth-health` - Health check de AliExpress
8. `fx-rates-refresh` - Refresh de tasas FX

**Evidencia:** `backend/src/services/job.service.ts`, `backend/src/services/scheduled-tasks.service.ts`

---

## ?? Comunicación entre Módulos

### 1. Frontend ? Backend

**Protocolo:** HTTP/HTTPS (REST API)

**Autenticación:** JWT tokens (Bearer)

**Endpoints principales:**
- `/api/auth/*` - Autenticación
- `/api/products/*` - Productos
- `/api/opportunities/*` - Oportunidades
- `/api/marketplace/*` - Marketplaces
- `/api/sales/*` - Ventas
- `/api/dashboard/*` - Dashboard

**Evidencia:** `backend/src/app.ts`, `frontend/src/services/api.ts`

---

### 2. Backend ? Base de Datos

**ORM:** Prisma Client

**Conexión:** PostgreSQL connection string

**Pooling:** Prisma connection pooling

**Evidencia:** `backend/src/config/database.ts`

---

### 3. Backend ? Redis

**Librería:** ioredis

**Uso:**
- Cache
- Colas BullMQ
- Rate limiting
- Session storage

**Evidencia:** `backend/src/config/redis.ts`

---

### 4. Backend ? APIs Externas

**APIs integradas:**
- eBay Trading API
- MercadoLibre API
- Amazon SP-API
- AliExpress Affiliate API
- GROQ AI API
- PayPal API
- ScraperAPI
- ZenRows
- 2Captcha
- Twilio (SMS)
- Nodemailer (Email)
- Slack API

**Evidencia:** `backend/src/services/ebay.service.ts`, `backend/src/services/mercadolibre.service.ts`, etc.

---

### 5. Frontend ? Backend (Real-time)

**Protocolo:** WebSocket (Socket.IO)

**Eventos:**
- `notification` - Notificaciones
- `job:progress` - Progreso de trabajos
- `product:updated` - Actualización de productos
- `sale:created` - Nueva venta

**Evidencia:** `backend/src/services/notification.service.ts`, `frontend/src/stores/authStore.ts`

---

## ??? Stack Tecnológico

### Backend

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| Node.js | 20+ | Runtime |
| TypeScript | 5.9.3 | Lenguaje |
| Express | 4.18.2 | Framework web |
| Prisma | 5.7.0 | ORM |
| BullMQ | 5.1.0 | Colas |
| Socket.IO | 4.6.0 | WebSocket |
| JWT | 9.0.2 | Autenticación |
| Axios | 1.6.2 | HTTP client |
| Puppeteer | 24.28.0 | Scraping |
| Winston | 3.11.0 | Logging |

**Evidencia:** `backend/package.json`

---

### Frontend

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| React | 18.2.0 | Framework UI |
| TypeScript | 5.2.2 | Lenguaje |
| Vite | 5.0.8 | Build tool |
| Zustand | 4.4.7 | State management |
| React Router | 6.20.1 | Routing |
| Socket.IO Client | 4.8.1 | WebSocket |
| Axios | 1.6.2 | HTTP client |
| Tailwind CSS | 3.3.6 | Styling |

**Evidencia:** `frontend/package.json`

---

### Base de Datos

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| PostgreSQL | 16+ | Base de datos |
| Prisma | 5.7.0 | ORM y migraciones |

**Evidencia:** `backend/prisma/schema.prisma`

---

### Infraestructura

| Servicio | Propósito |
|----------|-----------|
| Railway | Backend hosting + PostgreSQL + Redis |
| Vercel | Frontend hosting + CDN |
| GitHub | Version control + CI/CD |

**Evidencia:** `railway.json`, `vercel.json`

---

## ?? Flujo de Datos

### Flujo de Dropshipping End-to-End

```
1. BÚSQUEDA DE OPORTUNIDADES
   Frontend ? Backend ? AliExpress (Scraping)
   ?
   Backend ? Análisis IA (GROQ)
   ?
   Backend ? Competencia (eBay, ML, Amazon)
   ?
   Backend ? Cálculo ROI/Margen
   ?
   Backend ? PostgreSQL (Opportunity)
   ?
   Backend ? Frontend (WebSocket notification)

2. CREACIÓN DE PRODUCTO
   Frontend ? Backend ? PostgreSQL (Product)
   ?
   Backend ? Frontend (confirmation)

3. PUBLICACIÓN
   Frontend ? Backend ? Marketplace API (eBay/ML/Amazon)
   ?
   Backend ? PostgreSQL (MarketplaceListing)
   ?
   Backend ? Frontend (WebSocket notification)

4. VENTA
   Marketplace ? Backend (Webhook)
   ?
   Backend ? PostgreSQL (Sale)
   ?
   Backend ? Cálculo comisiones
   ?
   Backend ? PostgreSQL (Commission)
   ?
   Backend ? Frontend (WebSocket notification)

5. COMPRA AUTOMÁTICA
   Backend ? Validación capital
   ?
   Backend ? AliExpress (Purchase)
   ?
   Backend ? PostgreSQL (PurchaseLog)
   ?
   Backend ? Frontend (WebSocket notification)

6. FULFILLMENT
   Backend ? Tracking update
   ?
   Backend ? PostgreSQL (Sale update)
   ?
   Backend ? Frontend (WebSocket notification)
```

**Evidencia:** `backend/src/services/opportunity-finder.service.ts`, `backend/src/services/marketplace.service.ts`, `backend/src/services/aliexpress-auto-purchase.service.ts`

---

## ?? Seguridad

### Autenticación
- JWT tokens con refresh tokens
- Tokens en cookies (httpOnly) o headers (Bearer)
- Token blacklisting con Redis

### Autorización
- Roles: ADMIN, USER
- Middleware de autorización por ruta
- Aislamiento de datos por usuario (multi-tenant)

### Protección
- Helmet (security headers)
- CORS configurado
- Rate limiting
- Input validation (Zod)
- SQL injection protection (Prisma)

**Evidencia:** `backend/src/middleware/auth.middleware.ts`, `backend/src/middleware/security-headers.middleware.ts`

---

## ?? Escalabilidad

### Horizontal Scaling
- Stateless backend (puede escalar horizontalmente)
- Redis para sesiones compartidas
- PostgreSQL connection pooling

### Vertical Scaling
- Workers BullMQ procesan en paralelo
- Async/await para no bloquear event loop
- Connection pooling en Prisma

**Evidencia:** `backend/src/config/database.ts`, `backend/src/services/job.service.ts`

---

**Próximos pasos:** Ver [Documentación Técnica](./08_tecnico.md) para detalles de implementación.
